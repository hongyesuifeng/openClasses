# Reading 3: AI Native PRD in Action
# AI åŸç”Ÿ PRD æ’°å†™å®æˆ˜

> **Week 3 Reading #3**
> **ä¸»é¢˜**: æŒæ¡é¢å‘ AI Agent çš„äº§å“éœ€æ±‚æ–‡æ¡£æ’°å†™æ–¹æ³•
> **é¢„è®¡é˜…è¯»æ—¶é—´**: 60-90 åˆ†é’Ÿ

---

## ğŸ“š å¯¼è¯»

AI åŸç”Ÿ PRDï¼ˆProduct Requirements Documentï¼‰æ˜¯ä¸“é—¨ä¸º AI Agent è®¾è®¡çš„éœ€æ±‚æ–‡æ¡£ã€‚ä¸ä¼ ç»Ÿ PRD ä¸åŒï¼Œå®ƒåŒ…å«æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼Œè®© AI èƒ½å¤Ÿç›´æ¥ç†è§£å¹¶æ‰§è¡Œå¼€å‘ä»»åŠ¡ã€‚æœ¬æ–‡å°†å¸®åŠ©ä½ ï¼š

1. **ç†è§£ PRD çš„æ¼”è¿›** - ä»ä¼ ç»Ÿ PRD åˆ° AI åŸç”Ÿ PRD
2. **æŒæ¡æ ¸å¿ƒç»“æ„** - AI åŸç”Ÿ PRD çš„å…«å¤§è¦ç´ 
3. **å­¦ä¹ å®æˆ˜æŠ€å·§** - å…·ä½“çš„æ’°å†™æ–¹æ³•å’Œæ¨¡æ¿
4. **å®æˆ˜æ¡ˆä¾‹åˆ†æ** - å®Œæ•´çš„ PRD ç¤ºä¾‹

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é˜…è¯»å®Œæœ¬æ–‡åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- âœ… ç†è§£ä¼ ç»Ÿ PRD ä¸ AI åŸç”Ÿ PRD çš„åŒºåˆ«
- âœ… æŒæ¡ AI åŸç”Ÿ PRD çš„æ ¸å¿ƒç»“æ„
- âœ… èƒ½å¤Ÿæ’°å†™é«˜è´¨é‡çš„ AI åŸç”Ÿ PRD
- âœ… å­¦ä¼šå°†éœ€æ±‚è½¬æ¢ä¸º AI å¯ç†è§£çš„æ ¼å¼
- âœ… æŒæ¡ PRD é©±åŠ¨çš„ AI å¼€å‘æµç¨‹

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šPRD çš„æ¼”è¿›

### ä¼ ç»Ÿ PRD çš„é—®é¢˜

#### åœºæ™¯å¯¹æ¯”

```markdown
# ä¼ ç»Ÿ PRD å¼€å‘æµç¨‹

Day 1: äº§å“ç»ç†å†™ PRD
"å®ç°ç”¨æˆ·è¯„è®ºåŠŸèƒ½"

Day 2: å¼€å‘è€…é˜…è¯» PRD
"éœ€æ±‚ä¸å¤Ÿè¯¦ç»†..."
- éœ€è¦å“ªäº›å­—æ®µï¼Ÿ
- è¯„è®ºæƒé™å¦‚ä½•æ§åˆ¶ï¼Ÿ
- å¦‚ä½•å¤„ç†æ•æ„Ÿè¯ï¼Ÿ

Day 3: ä¼šè®®è®¨è®º
"è¡¥å……éœ€æ±‚ç»†èŠ‚..."

Day 4-5: å¼€å‘å®ç°
ï¼ˆè¾¹å¼€å‘è¾¹ç¡®è®¤ï¼‰

Day 6: æµ‹è¯•å‘ç°é—æ¼
"æ²¡æœ‰è€ƒè™‘è¯„è®ºå®¡æ ¸..."

Day 7: ä¿®æ”¹å’Œè¡¥å……
ï¼ˆè¿”å·¥ï¼‰

é—®é¢˜:
- éœ€æ±‚ä¸å®Œæ•´
- æ²Ÿé€šæˆæœ¬é«˜
- å¼€å‘æ•ˆç‡ä½
- å®¹æ˜“è¿”å·¥
```

```markdown
# AI åŸç”Ÿ PRD å¼€å‘æµç¨‹

Day 1: äº§å“ç»ç†å†™ AI åŸç”Ÿ PRD
"å®ç°ç”¨æˆ·è¯„è®ºåŠŸèƒ½ï¼ˆåŒ…å«æ‰€æœ‰ç»†èŠ‚ï¼‰"

Day 2-3: AI Agent å®ç°
@PRD.md @docs/architecture.md
"æ ¹æ® PRD å®ç°è¯„è®ºåŠŸèƒ½"

AI Agent:
1. åˆ†æ PRD
2. è®¾è®¡æ•°æ®æ¨¡å‹
3. å®ç° API
4. å®ç° UI
5. ç¼–å†™æµ‹è¯•
6. ç”Ÿæˆæ–‡æ¡£

Day 4: äººå·¥å®¡æŸ¥
ï¼ˆæ£€æŸ¥å®ç°æ˜¯å¦ç¬¦åˆé¢„æœŸï¼‰

Day 5: éƒ¨ç½²ä¸Šçº¿

ä¼˜åŠ¿:
- éœ€æ±‚å®Œæ•´
- æ— éœ€åå¤æ²Ÿé€š
- å¿«é€Ÿè¿­ä»£
- è´¨é‡å¯æ§
```

### å¯¹æ¯”åˆ†æ

| ç»´åº¦ | ä¼ ç»Ÿ PRD | AI åŸç”Ÿ PRD |
|------|---------|------------|
| **ç›®æ ‡è¯»è€…** | äººç±»å¼€å‘è€… | AI Agent |
| **è¯¦ç»†ç¨‹åº¦** | æ¦‚å¿µæ€§ | å®Œå…¨è¯¦ç»† |
| **ä¸Šä¸‹æ–‡** | ä¾èµ–å£å¤´è¡¥å…… | åŒ…å«æ‰€æœ‰ä¸Šä¸‹æ–‡ |
| **å¯æ‰§è¡Œæ€§** | éœ€è¦è§£è¯» | å¯ç›´æ¥æ‰§è¡Œ |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä¸­ |
| **å¼€å‘æ•ˆç‡** | ä½ | é«˜ |

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šAI åŸç”Ÿ PRD çš„å…«å¤§è¦ç´ 

### è¦ç´  1: åŠŸèƒ½æ¦‚è¿°

#### ç›®æ ‡

**æ¸…æ™°æè¿°è¦è§£å†³çš„é—®é¢˜å’Œç›®æ ‡**

```markdown
# ç¤ºä¾‹: ç”¨æˆ·è¯„è®ºåŠŸèƒ½

## é—®é¢˜èƒŒæ™¯
å½“å‰åšå®¢å¹³å°ç¼ºä¹ç”¨æˆ·äº’åŠ¨åŠŸèƒ½ï¼Œè¯»è€…æ— æ³•å¯¹æ–‡ç« å‘è¡¨è¯„è®ºï¼Œ
å¯¼è‡´ç”¨æˆ·å‚ä¸åº¦ä½ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¸è¶³ã€‚

## åŠŸèƒ½ç›®æ ‡
å®ç°ç”¨æˆ·è¯„è®ºç³»ç»Ÿï¼Œå…è®¸æ³¨å†Œç”¨æˆ·å¯¹æ–‡ç« å‘è¡¨è¯„è®ºï¼Œ
æå‡ç”¨æˆ·å‚ä¸åº¦å’Œç¤¾åŒºæ´»è·ƒåº¦ã€‚

## æˆåŠŸæŒ‡æ ‡
- æ–‡ç« è¯„è®ºç‡è¾¾åˆ° 5%ï¼ˆè¯„è®ºæ•°/é˜…è¯»æ•°ï¼‰
- ç”¨æˆ·å¹³å‡åœç•™æ—¶é—´æå‡ 30%
- æœˆæ´»è·ƒç”¨æˆ·å¢é•¿ 20%
```

#### SMART åŸåˆ™

```markdown
# å¥½çš„ç›®æ ‡ vs å·®çš„ç›®æ ‡

âŒ å·®çš„ç›®æ ‡:
"æå‡ç”¨æˆ·ä½“éªŒ"

é—®é¢˜: æ¨¡ç³Šï¼Œæ— æ³•è¡¡é‡

âœ… å¥½çš„ç›®æ ‡:
"åœ¨ 3 ä¸ªæœˆå†…ï¼Œå°†ç”¨æˆ·å¹³å‡ä¼šè¯æ—¶é•¿ä» 5 åˆ†é’Ÿæå‡åˆ° 7 åˆ†é’Ÿ"

ç¬¦åˆ SMART:
- Specificï¼ˆå…·ä½“ï¼‰: ä¼šè¯æ—¶é•¿
- Measurableï¼ˆå¯è¡¡é‡ï¼‰: 5 â†’ 7 åˆ†é’Ÿ
- Achievableï¼ˆå¯å®ç°ï¼‰: 40% å¢é•¿åˆç†
- Relevantï¼ˆç›¸å…³ï¼‰: æå‡ç”¨æˆ·ä½“éªŒ
- Time-boundï¼ˆæœ‰æ—¶é™ï¼‰: 3 ä¸ªæœˆ
```

### è¦ç´  2: ç”¨æˆ·æ•…äº‹

#### ç›®æ ‡ç”¨æˆ·ç”»åƒ

```markdown
# ç”¨æˆ·ç”»åƒ

## ç”»åƒ 1: è¯„è®ºè€… Alice

**åŸºæœ¬ä¿¡æ¯:**
- å¹´é¾„: 28 å²
- èŒä¸š: è½¯ä»¶å·¥ç¨‹å¸ˆ
- æŠ€æœ¯æ°´å¹³: é«˜

**ä½¿ç”¨åœºæ™¯:**
- é˜…è¯»æŠ€æœ¯æ–‡ç« åæƒ³åˆ†äº«è§è§£
- å¸Œæœ›ä¸ä½œè€…å’Œè¯»è€…è®¨è®º
- éœ€è¦ä»£ç æ ¼å¼åŒ–æ”¯æŒ

**ç—›ç‚¹:**
- å½“å‰æ— æ³•å‘è¡¨è¯„è®º
- æ— æ³•çœ‹åˆ°ä»–äººè¯„è®º
- æ— æ³•å›å¤è®¨è®º

**æœŸæœ›:**
- Markdown æ”¯æŒ
- ä»£ç é«˜äº®
- å®æ—¶é¢„è§ˆ

## ç”»åƒ 2: åšå®¢ä½œè€… Bob

**åŸºæœ¬ä¿¡æ¯:**
- å¹´é¾„: 35 å²
- èŒä¸š: æŠ€æœ¯åšä¸»
- æŠ€æœ¯æ°´å¹³: ä¸­

**ä½¿ç”¨åœºæ™¯:**
- éœ€è¦ç®¡ç†æ–‡ç« è¯„è®º
- å¸Œæœ›å›å¤è¯»è€…é—®é¢˜
- éœ€è¦å®¡æ ¸ä¸å½“å†…å®¹

**ç—›ç‚¹:**
- ç¼ºå°‘ä¸è¯»è€…äº’åŠ¨æ¸ é“
- æ— æ³•äº†è§£è¯»è€…åé¦ˆ

**æœŸæœ›:**
- è¯„è®ºå®¡æ ¸åŠŸèƒ½
- è¯„è®ºé€šçŸ¥
- æ•°æ®ç»Ÿè®¡
```

#### ä½¿ç”¨åœºæ™¯

```markdown
# ä¸»è¦åœºæ™¯

## åœºæ™¯ 1: å‘è¡¨è¯„è®º

**å‰ç½®æ¡ä»¶:**
- ç”¨æˆ·å·²ç™»å½•
- æ­£åœ¨æµè§ˆæ–‡ç« è¯¦æƒ…é¡µ

**æ“ä½œæµç¨‹:**
1. æ»šåŠ¨åˆ°æ–‡ç« åº•éƒ¨è¯„è®ºåŒº
2. åœ¨è¯„è®ºè¾“å…¥æ¡†è¾“å…¥å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰
3. å®æ—¶é¢„è§ˆè¯„è®ºæ•ˆæœ
4. ç‚¹å‡»"å‘å¸ƒè¯„è®º"æŒ‰é’®
5. ç³»ç»ŸéªŒè¯å†…å®¹
6. è¯„è®ºå‘å¸ƒæˆåŠŸ
7. é¡µé¢æ›´æ–°æ˜¾ç¤ºæ–°è¯„è®º

**åç½®æ¡ä»¶:**
- è¯„è®ºä¿å­˜åˆ°æ•°æ®åº“
- ä½œè€…æ”¶åˆ°é€šçŸ¥
- è¯„è®ºæ•° +1

**å¼‚å¸¸å¤„ç†:**
- æœªç™»å½•: è·³è½¬åˆ°ç™»å½•é¡µ
- å†…å®¹ä¸ºç©º: æ˜¾ç¤ºé”™è¯¯æç¤º
- æ•æ„Ÿè¯: æç¤ºä¿®æ”¹
- ç½‘ç»œé”™è¯¯: ä¿å­˜è‰ç¨¿
```

### è¦ç´  3: åŠŸèƒ½éœ€æ±‚

#### æ ¸å¿ƒåŠŸèƒ½

```markdown
# åŠŸèƒ½ 1: å‘è¡¨è¯„è®º

**è¾“å…¥:**
- articleId: æ–‡ç«  IDï¼ˆstring, requiredï¼‰
- content: è¯„è®ºå†…å®¹ï¼ˆstring, required, max 5000 å­—ç¬¦ï¼‰
- parentId: çˆ¶è¯„è®º IDï¼ˆstring, optional, ç”¨äºå›å¤ï¼‰

**å¤„ç†é€»è¾‘:**
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. éªŒè¯æ–‡ç« æ˜¯å¦å­˜åœ¨
3. éªŒè¯è¯„è®ºå†…å®¹:
   - é•¿åº¦æ£€æŸ¥ï¼ˆ1-5000 å­—ç¬¦ï¼‰
   - æ•æ„Ÿè¯è¿‡æ»¤
   - XSS é˜²æŠ¤
4. å¦‚æœæ˜¯å›å¤ï¼ŒéªŒè¯çˆ¶è¯„è®ºå­˜åœ¨
5. ä¿å­˜åˆ°æ•°æ®åº“:
   - id: UUID
   - articleId
   - userId
   - contentï¼ˆMarkdown æ ¼å¼ï¼‰
   - parentIdï¼ˆå¯é€‰ï¼‰
   - status: 'pending' | 'approved' | 'rejected'
   - createdAt
   - updatedAt
6. å¼‚æ­¥é€šçŸ¥æ–‡ç« ä½œè€…
7. è¿”å›è¯„è®ºå¯¹è±¡

**è¾“å‡º:**
```json
{
  "id": "comment-123",
  "articleId": "article-456",
  "user": {
    "id": "user-789",
    "name": "Alice",
    "avatar": "https://..."
  },
  "content": "Great article!",
  "contentHtml": "<p>Great article!</p>",
  "parentId": null,
  "status": "approved",
  "createdAt": "2025-01-05T10:30:00Z",
  "updatedAt": "2025-01-05T10:30:00Z",
  "replies": [],
  "replyCount": 0
}
```

**çº¦æŸæ¡ä»¶:**
- æ€§èƒ½: å“åº”æ—¶é—´ < 200ms
- å®‰å…¨: é˜²æ­¢ SQL æ³¨å…¥ã€XSS æ”»å‡»
- æ•°æ®: å†…å®¹æŒä¹…åŒ–ï¼Œ99.9% å¯ç”¨æ€§
```

#### è¾¹ç•Œæƒ…å†µ

```markdown
# è¾¹ç•Œæƒ…å†µå¤„ç†

## æƒ…å†µ 1: è¯„è®ºæƒé™
**è§„åˆ™:**
- ä»…æ³¨å†Œç”¨æˆ·å¯è¯„è®º
- è¢«å°ç¦ç”¨æˆ·ä¸å¯è¯„è®º
- æ–‡ç« ä½œè€…å¯åˆ é™¤ä»»ä½•è¯„è®º

**å¤„ç†:**
```typescript
if (!user.isAuthenticated) {
  throw new UnauthorizedError('Please login to comment');
}

if (user.isBanned) {
  throw new ForbiddenError('Your account has been banned');
}
```

## æƒ…å†µ 2: æ•æ„Ÿè¯è¿‡æ»¤
**è§„åˆ™:**
- æ£€æµ‹é¢„å®šä¹‰æ•æ„Ÿè¯åˆ—è¡¨
- ä¸­è‹±æ–‡æ··åˆæ£€æµ‹
- å˜ä½“æ£€æµ‹ï¼ˆå¦‚: $h!tï¼‰

**å¤„ç†:**
```typescript
const sensitiveWords = ['spam', 'abuse', ...];
const containsSensitiveWord = sensitiveWords.some(word =>
  content.toLowerCase().includes(word.toLowerCase())
);

if (containsSensitiveWord) {
  // è‡ªåŠ¨æ ‡è®°ä¸ºå¾…å®¡æ ¸
  comment.status = 'pending';
}
```

## æƒ…å†µ 3: è¯„è®ºé¢‘ç‡é™åˆ¶
**è§„åˆ™:**
- æ¯åˆ†é’Ÿæœ€å¤š 5 æ¡è¯„è®º
- æ¯å°æ—¶æœ€å¤š 20 æ¡è¯„è®º

**å¤„ç†:**
```typescript
const recentComments = await Comment.count({
  userId: user.id,
  createdAt: { $gt: new Date(Date.now() - 60 * 1000) }
});

if (recentComments >= 5) {
  throw new RateLimitError('Too many comments, please try again later');
}
```

## æƒ…å†µ 4: è¶…é•¿è¯„è®º
**è§„åˆ™:**
- æœ€å¤§ 5000 å­—ç¬¦

**å¤„ç†:**
```typescript
if (content.length > 5000) {
  throw new ValidationError('Comment too long (max 5000 characters)');
}
```

## æƒ…å†µ 5: å›å¤æ·±åº¦é™åˆ¶
**è§„åˆ™:**
- æœ€å¤š 3 å±‚åµŒå¥—

**å¤„ç†:**
```typescript
if (parentId) {
  const depth = await getCommentDepth(parentId);
  if (depth >= 3) {
    throw new ValidationError('Maximum reply depth exceeded');
  }
}
```
```

### è¦ç´  4: æŠ€æœ¯å®ç°æŒ‡å¯¼

#### æ•°æ®æ¨¡å‹

```markdown
# æ•°æ®æ¨¡å‹è®¾è®¡

## Comment è¡¨

```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_id UUID NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE CASCADE,

  -- å†…å®¹
  content TEXT NOT NULL,
  content_html TEXT NOT NULL,

  -- çŠ¶æ€
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
    -- 'pending': å¾…å®¡æ ¸
    -- 'approved': å·²é€šè¿‡
    -- 'rejected': å·²æ‹’ç»

  -- å…ƒæ•°æ®
  ip_address INET,
  user_agent TEXT,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

  -- ç´¢å¼•
  INDEX idx_article_id (article_id),
  INDEX idx_user_id (user_id),
  INDEX idx_parent_id (parent_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);

-- è¯„è®ºç»Ÿè®¡
CREATE TABLE comment_stats (
  article_id UUID PRIMARY KEY REFERENCES articles(id) ON DELETE CASCADE,
  comment_count INTEGER NOT NULL DEFAULT 0,
  last_comment_at TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

## æ•°æ®æ¨¡å‹è¯´æ˜

**å­—æ®µè§£é‡Š:**

- `id`: UUIDï¼Œå”¯ä¸€æ ‡è¯†
- `article_id`: å…³è”æ–‡ç« ï¼Œçº§è”åˆ é™¤
- `user_id`: å…³è”ç”¨æˆ·ï¼Œçº§è”åˆ é™¤
- `parent_id`: çˆ¶è¯„è®ºï¼Œç”¨äºå›å¤
- `content`: Markdown åŸæ–‡
- `content_html`: æ¸²æŸ“åçš„ HTML
- `status`: å®¡æ ¸çŠ¶æ€
- `ip_address`: ä¿ç•™ IPï¼ˆç”¨äºååƒåœ¾ï¼‰
- `user_agent`: ç”¨æˆ·ä»£ç†

**å…³ç³»:**
```
User 1:N Comment
Article 1:N Comment
Comment 1:N Comment (self-referential)
```
```

#### API è®¾è®¡

```markdown
# API ç«¯ç‚¹è®¾è®¡

## 1. åˆ›å»ºè¯„è®º

**ç«¯ç‚¹:** `POST /api/articles/:articleId/comments`

**è®¤è¯:** Required (Bearer Token)

**è¯·æ±‚ä½“:**
```json
{
  "content": "Great article! Thanks for sharing.",
  "parentId": "comment-123"  // å¯é€‰ï¼Œå›å¤æ—¶æä¾›
}
```

**å“åº”:** 201 Created
```json
{
  "success": true,
  "data": {
    "id": "comment-456",
    "content": "Great article! Thanks for sharing.",
    "contentHtml": "<p>Great article! Thanks for sharing.</p>",
    "user": {
      "id": "user-789",
      "name": "Alice",
      "avatar": "https://cdn.example.com/avatars/789.jpg"
    },
    "parentId": "comment-123",
    "status": "approved",
    "createdAt": "2025-01-05T10:30:00Z",
    "replies": []
  }
}
```

## 2. è·å–æ–‡ç« è¯„è®º

**ç«¯ç‚¹:** `GET /api/articles/:articleId/comments`

**è®¤è¯:** Optional

**æŸ¥è¯¢å‚æ•°:**
- `page`: é¡µç ï¼ˆé»˜è®¤: 1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤: 20, æœ€å¤§: 100ï¼‰
- `sort`: æ’åºæ–¹å¼ï¼ˆlatest, popularï¼‰
- `parentId`: çˆ¶è¯„è®º IDï¼ˆè·å–å›å¤ï¼‰

**ç¤ºä¾‹:** `GET /api/articles/article-456/comments?page=1&limit=20&sort=latest`

**å“åº”:** 200 OK
```json
{
  "success": true,
  "data": {
    "comments": [
      {
        "id": "comment-123",
        "content": "Very helpful!",
        "contentHtml": "<p>Very helpful!</p>",
        "user": {
          "id": "user-789",
          "name": "Alice",
          "avatar": "https://..."
        },
        "status": "approved",
        "createdAt": "2025-01-05T10:00:00Z",
        "updatedAt": "2025-01-05T10:00:00Z",
        "likes": 5,
        "isLiked": false,
        "replies": [
          {
            "id": "comment-124",
            "content": "I agree!",
            "contentHtml": "<p>I agree!</p>",
            "user": {...},
            "status": "approved",
            "createdAt": "2025-01-05T10:05:00Z",
            "likes": 2
          }
        ],
        "replyCount": 1
      }
    ],
    "pagination": {
      "total": 45,
      "page": 1,
      "limit": 20,
      "totalPages": 3
    }
  }
}
```

## 3. åˆ é™¤è¯„è®º

**ç«¯ç‚¹:** `DELETE /api/comments/:commentId`

**è®¤è¯:** Required

**æƒé™:**
- è¯„è®ºä½œè€…
- æ–‡ç« ä½œè€…
- ç®¡ç†å‘˜

**å“åº”:** 204 No Content

## 4. å®¡æ ¸è¯„è®º

**ç«¯ç‚¹:** `PATCH /api/comments/:commentId/status`

**è®¤è¯:** Required (Admin/Author)

**è¯·æ±‚ä½“:**
```json
{
  "status": "approved"  // 'approved' | 'rejected'
}
```

**å“åº”:** 200 OK
```

### è¦ç´  5: äº¤äº’è®¾è®¡

#### UI è®¾è®¡

```markdown
# UI è®¾è®¡è§„èŒƒ

## è¯„è®ºè¾“å…¥åŒº

**ä½ç½®:** æ–‡ç« åº•éƒ¨

**ç»„ä»¶ç»“æ„:**
```
<CommentInput>
  <UserAvatar />
  <Textarea
    placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
    maxLength={5000}
    showCount
  />
  <Toolbar>
    <MarkdownGuide />
    <PreviewToggle />
  </Toolbar>
  <PreviewArea>
    {isPreview && <MarkdownRender content={content} />}
  </PreviewArea>
  <Actions>
    <CancelButton />
    <SubmitButton disabled={!content || submitting}>
      {submitting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒè¯„è®º'}
    </SubmitButton>
  </Actions>
</CommentInput>
```

**äº¤äº’è§„èŒƒ:**
1. è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
2. è¾“å…¥æ—¶å®æ—¶å­—ç¬¦è®¡æ•°
3. Ctrl/Cmd + Enter æäº¤
4. æäº¤ä¸­ç¦ç”¨æŒ‰é’®å’Œè¾“å…¥æ¡†
5. æäº¤å¤±è´¥ä¿ç•™å†…å®¹
6. æ”¯æŒ Markdown è¯­æ³•

## è¯„è®ºåˆ—è¡¨

**æ˜¾ç¤ºè§„åˆ™:**
- åˆ†é¡µåŠ è½½ï¼ˆæ¯é¡µ 20 æ¡ï¼‰
- é»˜è®¤æŒ‰æœ€æ–°æ’åº
- æ”¯æŒæŒ‰çƒ­é—¨æ’åº
- å›å¤ç¼©è¿›æ˜¾ç¤ºï¼ˆæœ€å¤š 3 å±‚ï¼‰

**ç»„ä»¶ç»“æ„:**
```
<CommentList>
  <SortSelector
    options={['latest', 'popular']}
    value={sort}
    onChange={setSort}
  />
  <CommentGroup>
    {comments.map(comment => (
      <CommentItem key={comment.id}>
        <CommentHeader>
          <UserAvatar src={comment.user.avatar} />
          <UserInfo>
            <UserName>{comment.user.name}</UserName>
            <CommentTime>{formatTime(comment.createdAt)}</CommentTime>
          </UserInfo>
          <CommentMenu>
            <ReplyButton />
            <LikeButton />
            {canDelete && <DeleteButton />}
          </CommentMenu>
        </CommentHeader>
        <CommentBody>
          <MarkdownRender>{comment.contentHtml}</MarkdownRender>
        </CommentBody>
        {comment.replies.length > 0 && (
          <CommentReplies>
            {comment.replies.map(reply => (
              <CommentItem key={reply.id} {...reply} isReply />
            ))}
          </CommentReplies>
        )}
      </CommentItem>
    ))}
  </CommentGroup>
  <Pagination {...pagination} />
</CommentList>
```

**è§†è§‰è§„èŒƒ:**
```
å­—ä½“:
- ç”¨æˆ·å: 14px, medium
- æ—¶é—´: 12px, regular, gray
- å†…å®¹: 15px, regular, leading 1.6

é—´è·:
- è¯„è®ºé—´è·: 16px
- å†…å®¹è¾¹è·: 12px 0
- å›å¤ç¼©è¿›: 48px

é¢œè‰²:
- èƒŒæ™¯è‰²: #ffffff
- è¾¹æ¡†è‰²: #e5e7eb
- ä¸»è‰²: #3b82f6
- æ–‡æœ¬è‰²: #1f2937
- æ¬¡è¦æ–‡æœ¬: #6b7280
```
```

#### çŠ¶æ€ç®¡ç†

```markdown
# çŠ¶æ€ç®¡ç†è®¾è®¡

## Redux State Structure

```typescript
interface CommentsState {
  // åˆ—è¡¨æ•°æ®
  byArticleId: {
    [articleId: string]: {
      comments: Comment[];
      pagination: Pagination;
      loading: boolean;
      error: string | null;
    };
  };

  // å½“å‰ç¼–è¾‘
  editing: {
    articleId: string | null;
    parentId: string | null;
    content: string;
    isPreview: boolean;
    submitting: boolean;
  };

  // UI çŠ¶æ€
  ui: {
    sortBy: 'latest' | 'popular';
    expandedReplies: Set<string>;
  };
}

// Actions
interface CommentsActions {
  // è·å–è¯„è®º
  fetchComments(
    articleId: string,
    page: number,
    sort: 'latest' | 'popular'
  ): Promise<void>;

  // åˆ›å»ºè¯„è®º
  createComment(
    articleId: string,
    content: string,
    parentId?: string
  ): Promise<Comment>;

  // åˆ é™¤è¯„è®º
  deleteComment(commentId: string): Promise<void>;

  // æ›´æ–°ç¼–è¾‘çŠ¶æ€
  updateEditing(content: string): void;

  // åˆ‡æ¢é¢„è§ˆ
  togglePreview(): void;

  // å±•å¼€/æŠ˜å å›å¤
  toggleReplies(commentId: string): void;
}
```

## æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
    â†“
Dispatch Action
    â†“
Reducer æ›´æ–° State
    â†“
Selector è®¡ç®—æ´¾ç”Ÿæ•°æ®
    â†“
Component Re-render
    â†“
UI æ›´æ–°
```
```

### è¦ç´  6: æ•°æ®æ¨¡å‹

è¯¦ç»†çš„æ•°æ®æ¨¡å‹å·²åœ¨è¦ç´  4 ä¸­å±•ç¤ºï¼Œè¿™é‡Œè¡¥å……å…³ç³»å›¾ï¼š

```markdown
# æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Comment   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ N
       â”‚
       â”‚ 1
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Article   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Self-referential:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Comment   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚ parent
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Comment   â”‚ (replies)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
```

### è¦ç´  7: æµ‹è¯•ç­–ç•¥

```markdown
# æµ‹è¯•ç­–ç•¥

## å•å…ƒæµ‹è¯•

### ç›®æ ‡è¦†ç›–ç‡: 85%+

### Service å±‚æµ‹è¯•

```typescript
describe('CommentService', () => {
  describe('createComment', () => {
    it('should create comment successfully', async () => {
      const comment = await commentService.createComment({
        articleId: 'article-123',
        userId: 'user-456',
        content: 'Test comment'
      });

      expect(comment.id).toBeDefined();
      expect(comment.content).toBe('Test comment');
      expect(comment.status).toBe('pending');
    });

    it('should reject comment exceeding max length', async () => {
      await expect(
        commentService.createComment({
          articleId: 'article-123',
          userId: 'user-456',
          content: 'x'.repeat(5001)
        })
      ).rejects.toThrow('Comment too long');
    });

    it('should filter sensitive words', async () => {
      const comment = await commentService.createComment({
        articleId: 'article-123',
        userId: 'user-456',
        content: 'This is spam content'
      });

      expect(comment.status).toBe('pending');
    });

    it('should enforce rate limit', async () => {
      // Create 5 comments within 1 minute
      const promises = Array(5).fill(null).map(() =>
        commentService.createComment({
          articleId: 'article-123',
          userId: 'user-456',
          content: 'Test'
        })
      );

      await Promise.all(promises);

      // 6th comment should fail
      await expect(
        commentService.createComment({
          articleId: 'article-123',
          userId: 'user-456',
          content: 'Test'
        })
      ).rejects.toThrow('Rate limit exceeded');
    });
  });

  describe('deleteComment', () => {
    it('should allow author to delete comment', async () => {
      const comment = await createTestComment({
        userId: 'user-123'
      });

      await commentService.deleteComment(comment.id, 'user-123');

      const deleted = await Comment.findById(comment.id);
      expect(deleted).toBeNull();
    });

    it('should not allow non-author to delete', async () => {
      const comment = await createTestComment({
        userId: 'user-123'
      });

      await expect(
        commentService.deleteComment(comment.id, 'user-456')
      ).rejects.toThrow('Forbidden');
    });
  });
});
```

## é›†æˆæµ‹è¯•

```typescript
describe('Comment API Integration', () => {
  describe('POST /api/articles/:articleId/comments', () => {
    it('should create comment', async () => {
      const response = await request(app)
        .post('/api/articles/article-123/comments')
        .set('Authorization', `Bearer ${token}`)
        .send({
          content: 'Great article!'
        });

      expect(response.status).toBe(201);
      expect(response.body.data.content).toBe('Great article!');
      expect(response.body.data.user.id).toBe(userId);
    });

    it('should return 401 without auth', async () => {
      const response = await request(app)
        .post('/api/articles/article-123/comments')
        .send({
          content: 'Test'
        });

      expect(response.status).toBe(401);
    });

    it('should validate content length', async () => {
      const response = await request(app)
        .post('/api/articles/article-123/comments')
        .set('Authorization', `Bearer ${token}`)
        .send({
          content: 'x'.repeat(5001)
        });

      expect(response.status).toBe(400);
      expect(response.body.error.code).toBe('VALIDATION_ERROR');
    });
  });
});
```

## E2E æµ‹è¯•

```typescript
describe('Comment E2E', () => {
  it('should complete comment flow', async () => {
    // 1. ç™»å½•
    await page.goto('/login');
    await page.fill('#email', 'user@example.com');
    await page.fill('#password', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL('/');

    // 2. å¯¼èˆªåˆ°æ–‡ç« 
    await page.goto('/articles/article-123');

    // 3. æ»šåŠ¨åˆ°è¯„è®ºåŒº
    await page.evaluate(() => {
      document.querySelector('.comment-section').scrollIntoView();
    });

    // 4. è¾“å…¥è¯„è®º
    await page.fill('textarea[name="content"]', 'Great article!');

    // 5. æäº¤è¯„è®º
    await page.click('button[type="submit"]');

    // 6. éªŒè¯è¯„è®ºæ˜¾ç¤º
    const comment = await page.waitForSelector('.comment-item');
    const text = await comment.evaluate(el => el.textContent);
    expect(text).toContain('Great article!');
  });
});
```

## æ€§èƒ½æµ‹è¯•

```typescript
describe('Performance', () => {
  it('should handle 100 concurrent comments', async () => {
    const start = Date.now();

    await Promise.all(
      Array(100).fill(null).map((_, i) =>
        commentService.createComment({
          articleId: 'article-123',
          userId: `user-${i}`,
          content: `Comment ${i}`
        })
      )
    );

    const duration = Date.now() - start;
    expect(duration).toBeLessThan(5000); // < 5s
  });

  it('should load 1000 comments in < 1s', async () => {
    await createTestComments(1000);

    const start = Date.now();
    const comments = await commentService.getComments('article-123', {
      page: 1,
      limit: 100
    });
    const duration = Date.now() - start;

    expect(comments).toHaveLength(100);
    expect(duration).toBeLessThan(1000);
  });
});
```
```

### è¦ç´  8: AI å¼€å‘æŒ‡å¯¼

```markdown
# AI Agent å¼€å‘æŒ‡å¯¼

## å¼€å‘æ­¥éª¤

### Step 1: åˆ†æéœ€æ±‚
@README.md @docs/architecture.md @PRD.md
"ç†è§£è¯„è®ºåŠŸèƒ½çš„æ•´ä½“éœ€æ±‚å’Œæ¶æ„"

### Step 2: è®¾è®¡æ•°æ®æ¨¡å‹
@src/models/
"åŸºäº PRD çš„æ•°æ®æ¨¡å‹è®¾è®¡ï¼Œåˆ›å»º Prisma schema"

### Step 3: å®ç° Service å±‚
@src/services/comment.service.ts
"å®ç°è¯„è®ºä¸šåŠ¡é€»è¾‘:
- createComment
- getComments
- deleteComment
- approveComment
- rejectComment

åŒ…å«:
- è¾“å…¥éªŒè¯
- æ•æ„Ÿè¯è¿‡æ»¤
- é¢‘ç‡é™åˆ¶
- æƒé™æ£€æŸ¥"

### Step 4: å®ç° API ç«¯ç‚¹
@src/controllers/comment.controller.ts
@src/routes/comment.routes.ts
"å®ç° REST API ç«¯ç‚¹:
- POST /api/articles/:articleId/comments
- GET /api/articles/:articleId/comments
- DELETE /api/comments/:id
- PATCH /api/comments/:id/status"

### Step 5: å®ç°å‰ç«¯ç»„ä»¶
@src/frontend/components/comments/
"åˆ›å»º React ç»„ä»¶:
- CommentInput.tsx
- CommentList.tsx
- CommentItem.tsx
- CommentForm.tsx

ä½¿ç”¨:
- Material-UI ç»„ä»¶
- React Markdown æ¸²æŸ“
- Redux Toolkit çŠ¶æ€ç®¡ç†"

### Step 6: å®ç° Redux é€»è¾‘
@src/frontend/store/slices/commentSlice.ts
"å®ç°è¯„è®ºçŠ¶æ€ç®¡ç†:
- fetchComments
- createComment
- deleteComment
- updateEditing"

### Step 7: ç¼–å†™æµ‹è¯•
@tests/unit/comment.service.test.ts
@tests/integration/comment.api.test.ts
"ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œè¦†ç›–ç‡ > 85%"

### Step 8: è¿è¡Œå’ŒéªŒè¯
"è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡:
pnpm test

æ£€æŸ¥è¦†ç›–ç‡:
pnpm test:coverage"

### Step 9: ç”Ÿæˆæ–‡æ¡£
@docs/features/comments.md
"ç”ŸæˆåŠŸèƒ½æ–‡æ¡£ï¼ŒåŒ…æ‹¬:
- åŠŸèƒ½æ¦‚è¿°
- API ä½¿ç”¨è¯´æ˜
- ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹
- é…ç½®è¯´æ˜"

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ç”¨æˆ·å¯ä»¥å‘è¡¨è¯„è®º
- [ ] è¯„è®ºæ”¯æŒ Markdown
- [ ] è¯„è®ºæ”¯æŒå›å¤ï¼ˆæœ€å¤š 3 å±‚ï¼‰
- [ ] æ•æ„Ÿè¯è‡ªåŠ¨è¿‡æ»¤
- [ ] é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ
- [ ] æ–‡ç« ä½œè€…å¯åˆ é™¤è¯„è®º
- [ ] æ”¯æŒè¯„è®ºå®¡æ ¸
- [ ] è¯„è®ºé€šçŸ¥å‘é€

### æŠ€æœ¯éªŒæ”¶
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ> 85% è¦†ç›–ç‡ï¼‰
- [ ] æ—  TypeScript é”™è¯¯
- [ ] æ—  ESLint è­¦å‘Š
- [ ] API å“åº”æ—¶é—´ < 200ms (P95)
- [ ] å‰ç«¯æ€§èƒ½å¾—åˆ† > 90

### æ–‡æ¡£éªŒæ”¶
- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] ç»„ä»¶ä½¿ç”¨æ–‡æ¡£å®Œæ•´
- [ ] ä»£ç æ³¨é‡Šå……åˆ†
- [ ] README å·²æ›´æ–°

## å¸¸è§æç¤ºè¯æ¨¡æ¿

### åˆ›å»ºåŠŸèƒ½
```
åŸºäº @PRD.md å®ç°è¯„è®ºåŠŸèƒ½:
1. æ•°æ®æ¨¡å‹ï¼ˆPrismaï¼‰
2. Service å±‚ä¸šåŠ¡é€»è¾‘
3. API ç«¯ç‚¹
4. å‰ç«¯ç»„ä»¶
5. çŠ¶æ€ç®¡ç†
6. æµ‹è¯•ç”¨ä¾‹

è¦æ±‚:
- éµå¾ªé¡¹ç›®æ¶æ„
- ç¬¦åˆä»£ç è§„èŒƒ
- å®Œæ•´é”™è¯¯å¤„ç†
- 85%+ æµ‹è¯•è¦†ç›–ç‡
```

### ä¿®å¤ Bug
```
ä¿®å¤è¯„è®ºåŠŸèƒ½ Bug:
@error.log @src/services/comment.service.ts

é”™è¯¯ä¿¡æ¯: [å¤åˆ¶å®Œæ•´é”™è¯¯]

å¤ç°æ­¥éª¤:
1. [æ­¥éª¤ 1]
2. [æ­¥éª¤ 2]

è¯·:
1. åˆ†ææ ¹æœ¬åŸå› 
2. æä¾›ä¿®å¤æ–¹æ¡ˆ
3. å®æ–½ä¿®å¤
4. æ·»åŠ é¢„é˜²æ€§æµ‹è¯•
5. éªŒè¯æ— å›å½’
```

### ä¼˜åŒ–æ€§èƒ½
```
ä¼˜åŒ–è¯„è®ºåˆ—è¡¨æ€§èƒ½:
@src/services/comment.service.ts @src/frontend/components/CommentList.tsx

å½“å‰é—®é¢˜:
- åŠ è½½ 100 æ¡è¯„è®ºéœ€è¦ 2 ç§’
- æ»šåŠ¨æœ‰å¡é¡¿

ä¼˜åŒ–ç›®æ ‡:
- åŠ è½½æ—¶é—´ < 500ms
- æ»šåŠ¨æµç•…ï¼ˆ60fpsï¼‰

è¯·:
1. åˆ†ææ€§èƒ½ç“¶é¢ˆ
2. æå‡ºä¼˜åŒ–æ–¹æ¡ˆ
3. å®æ–½ä¼˜åŒ–
4. æ€§èƒ½æµ‹è¯•éªŒè¯
```
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®Œæ•´ PRD ç¤ºä¾‹

### ç¤ºä¾‹: ç”¨æˆ·è®¤è¯åŠŸèƒ½

```markdown
# PRD: ç”¨æˆ·è®¤è¯åŠŸèƒ½

## 1. åŠŸèƒ½æ¦‚è¿°

### é—®é¢˜
å½“å‰ç³»ç»Ÿç¼ºå°‘ç”¨æˆ·è®¤è¯æœºåˆ¶ï¼Œæ— æ³•å®ç°ç”¨æˆ·ç®¡ç†å’Œä¸ªæ€§åŒ–åŠŸèƒ½ã€‚

### ç›®æ ‡
å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•ã€ç™»å‡ºã€å¯†ç æ‰¾å›ç­‰åŠŸèƒ½ã€‚

### æˆåŠŸæŒ‡æ ‡
- æ³¨å†Œè½¬åŒ–ç‡ > 60%ï¼ˆè®¿é—®æ³¨å†Œé¡µ / å®Œæˆæ³¨å†Œï¼‰
- ç™»å½•æˆåŠŸç‡ > 95%
- å¹³å‡ç™»å½•æ—¶é—´ < 2 ç§’
- å¯†ç æ‰¾å›æˆåŠŸç‡ > 80%

## 2. ç”¨æˆ·æ•…äº‹

### ç”»åƒ 1: æ–°ç”¨æˆ· Alice
**åœºæ™¯:**
- é¦–æ¬¡è®¿é—®ç½‘ç«™
- å¸Œæœ›å¿«é€Ÿæ³¨å†Œè´¦å·
- æ‹…å¿ƒå¯†ç å®‰å…¨

**æœŸæœ›:**
- ç®€å•çš„æ³¨å†Œæµç¨‹
- å¯†ç å¼ºåº¦æç¤º
- é‚®ç®±éªŒè¯

### ç”»åƒ 2: å›è®¿ç”¨æˆ· Bob
**åœºæ™¯:**
- å·²æ³¨å†Œç”¨æˆ·
- å¸Œæœ›å¿«é€Ÿç™»å½•
- å¯èƒ½å¿˜è®°å¯†ç 

**æœŸæœ›:**
- è®°ä½ç™»å½•çŠ¶æ€
- å¿«é€Ÿç™»å½•ï¼ˆæ”¯æŒç¤¾äº¤ç™»å½•ï¼‰
- å¯†ç æ‰¾å›åŠŸèƒ½

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 ç”¨æˆ·æ³¨å†Œ

**è¾“å…¥:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "name": "John Doe"
}
```

**éªŒè¯è§„åˆ™:**
- é‚®ç®±æ ¼å¼ï¼šæ ‡å‡† email æ ¼å¼
- é‚®ç®±å”¯ä¸€ï¼šä¸å…è®¸é‡å¤æ³¨å†Œ
- å¯†ç å¼ºåº¦ï¼š
  - æœ€å°‘ 8 å­—ç¬¦
  - åŒ…å«å¤§å°å†™å­—æ¯
  - åŒ…å«æ•°å­—
  - åŒ…å«ç‰¹æ®Šå­—ç¬¦
- å§“åï¼š2-50 å­—ç¬¦

**å¤„ç†æµç¨‹:**
1. éªŒè¯è¾“å…¥æ ¼å¼
2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
3. å¯†ç åŠ å¯†ï¼ˆbcrypt, salt rounds: 10ï¼‰
4. åˆ›å»ºç”¨æˆ·è®°å½•
5. ç”Ÿæˆé‚®ç®±éªŒè¯ token
6. å‘é€éªŒè¯é‚®ä»¶
7. è¿”å›ç”¨æˆ·å¯¹è±¡ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰

**è¾“å‡º:**
```json
{
  "user": {
    "id": "user-123",
    "email": "user@example.com",
    "name": "John Doe",
    "isVerified": false,
    "createdAt": "2025-01-05T10:30:00Z"
  },
  "message": "Registration successful. Please check your email to verify your account."
}
```

### 3.2 ç”¨æˆ·ç™»å½•

**è¾“å…¥:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**å¤„ç†æµç¨‹:**
1. éªŒè¯è¾“å…¥æ ¼å¼
2. æŸ¥è¯¢ç”¨æˆ·è®°å½•
3. éªŒè¯å¯†ç 
4. æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦è¢«å°ç¦ï¼‰
5. ç”Ÿæˆ JWT tokens:
   - Access token (15 åˆ†é’Ÿ)
   - Refresh token (7 å¤©)
6. è®°å½•ç™»å½•æ—¥å¿—ï¼ˆIP, æ—¶é—´ï¼‰
7. è¿”å› tokens å’Œç”¨æˆ·ä¿¡æ¯

**è¾“å‡º:**
```json
{
  "user": {
    "id": "user-123",
    "email": "user@example.com",
    "name": "John Doe",
    "avatar": "https://cdn.example.com/avatars/123.jpg"
  },
  "tokens": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 900
  }
}
```

### 3.3 åˆ·æ–° Token

**è¾“å…¥:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**å¤„ç†æµç¨‹:**
1. éªŒè¯ refresh token
2. æ£€æŸ¥ token æ˜¯å¦åœ¨é»‘åå•
3. ç”Ÿæˆæ–°çš„ access token
4. ï¼ˆå¯é€‰ï¼‰è½®æ¢ refresh token
5. è¿”å›æ–° token

**è¾“å‡º:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 900
}
```

### 3.4 å¯†ç æ‰¾å›

**è¾“å…¥:**
```json
{
  "email": "user@example.com"
}
```

**å¤„ç†æµç¨‹:**
1. éªŒè¯é‚®ç®±æ ¼å¼
2. æŸ¥è¯¢ç”¨æˆ·ï¼ˆä¸ç®¡æ˜¯å¦å­˜åœ¨ï¼Œéƒ½è¿”å›æˆåŠŸï¼Œé˜²æ­¢é‚®ç®±æšä¸¾ï¼‰
3. ç”Ÿæˆé‡ç½® tokenï¼ˆUUIDï¼Œæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰
4. ä¿å­˜åˆ°æ•°æ®åº“
5. å‘é€å¯†ç é‡ç½®é‚®ä»¶
6. è¿”å›æˆåŠŸæ¶ˆæ¯

**é‚®ä»¶å†…å®¹:**
```
Subject: Reset Your Password

Hi John,

We received a request to reset your password. Click the link below to reset it:

https://example.com/reset-password?token=abc123...

This link will expire in 1 hour.

If you didn't request this, please ignore this email.

Best,
The Team
```

**è¾“å‡º:**
```json
{
  "message": "If an account exists with this email, a password reset link has been sent."
}
```

### 3.5 é‡ç½®å¯†ç 

**è¾“å…¥:**
```json
{
  "token": "abc123...",
  "newPassword": "NewSecurePass456!"
}
```

**å¤„ç†æµç¨‹:**
1. éªŒè¯ token æœ‰æ•ˆæ€§
2. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
3. éªŒè¯æ–°å¯†ç å¼ºåº¦
4. æ›´æ–°å¯†ç 
5. ä½¿ token å¤±æ•ˆ
6. ä½¿æ‰€æœ‰ç°æœ‰ refresh tokens å¤±æ•ˆ
7. å‘é€å¯†ç å·²æ›´æ”¹é€šçŸ¥é‚®ä»¶
8. è¿”å›æˆåŠŸæ¶ˆæ¯

**è¾“å‡º:**
```json
{
  "message": "Password has been reset successfully. Please login with your new password."
}
```

## 4. æŠ€æœ¯å®ç°

### æ•°æ®æ¨¡å‹

```prisma
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  avatar        String?
  isVerified    Boolean   @default(false)
  isBanned      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions      Session[]
  passwordResets PasswordReset[]
  loginLogs     LoginLog[]

  @@index([email])
  @@index([isVerified])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model LoginLog {
  id        String   @id @default(uuid())
  userId    String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}
```

### API ç«¯ç‚¹

```typescript
// POST /api/auth/register
// POST /api/auth/login
// POST /api/auth/logout
// POST /api/auth/refresh
// POST /api/auth/forgot-password
// POST /api/auth/reset-password
// GET /api/auth/verify-email?token=xxx
```

## 5. å®‰å…¨è€ƒè™‘

### å¯†ç å®‰å…¨
- ä½¿ç”¨ bcrypt åŠ å¯†ï¼ˆsalt rounds: 10ï¼‰
- å¯†ç å¼ºåº¦éªŒè¯
- é˜²æ­¢å¸¸è§å¯†ç ï¼ˆpassword, 123456ç­‰ï¼‰

### Token å®‰å…¨
- Access token çŸ­æœŸæœ‰æ•ˆï¼ˆ15 åˆ†é’Ÿï¼‰
- Refresh token é•¿æœŸæœ‰æ•ˆï¼ˆ7 å¤©ï¼‰
- Token æ”¯æŒæ’¤é”€ï¼ˆé»‘åå•æœºåˆ¶ï¼‰
- HTTPS ä¼ è¾“

### é˜²æ­¢æš´åŠ›ç ´è§£
- ç™»å½•å¤±è´¥ 5 æ¬¡åé”å®šè´¦å· 15 åˆ†é’Ÿ
- IP é™æµï¼ˆæ¯åˆ†é’Ÿ 10 æ¬¡å°è¯•ï¼‰
- éªŒè¯ç ï¼ˆ3 æ¬¡å¤±è´¥åï¼‰

### ä¼šè¯ç®¡ç†
- æ”¯æŒå¤šè®¾å¤‡ç™»å½•
- å¯æ’¤é”€ç‰¹å®šè®¾å¤‡
- å¼‚å¸¸ç™»å½•æ£€æµ‹ï¼ˆIP å˜åŒ–ï¼‰

## 6. æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- å¯†ç åŠ å¯†éªŒè¯
- Token ç”Ÿæˆå’ŒéªŒè¯
- é‚®ç®±æ ¼å¼éªŒè¯
- å¯†ç å¼ºåº¦æ£€æŸ¥

### é›†æˆæµ‹è¯•
- æ³¨å†Œæµç¨‹
- ç™»å½•æµç¨‹
- å¯†ç æ‰¾å›æµç¨‹
- Token åˆ·æ–°æµç¨‹

### E2E æµ‹è¯•
- å®Œæ•´æ³¨å†Œæµç¨‹
- å®Œæ•´ç™»å½•æµç¨‹
- å¯†ç æ‰¾å›æµç¨‹

### å®‰å…¨æµ‹è¯•
- SQL æ³¨å…¥æµ‹è¯•
- XSS æ”»å‡»æµ‹è¯•
- CSRF æ”»å‡»æµ‹è¯•
- æš´åŠ›ç ´è§£æµ‹è¯•

## 7. AI å¼€å‘æŒ‡å¯¼

### å¼€å‘é¡ºåº
1. æ•°æ®æ¨¡å‹ï¼ˆPrismaï¼‰
2. Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
3. API ç«¯ç‚¹ï¼ˆæ§åˆ¶å™¨ï¼‰
4. å‰ç«¯ç»„ä»¶ï¼ˆç™»å½•è¡¨å•ã€æ³¨å†Œè¡¨å•ï¼‰
5. çŠ¶æ€ç®¡ç†ï¼ˆReduxï¼‰
6. æµ‹è¯•ç”¨ä¾‹

### å…³é”®æç¤ºè¯
```
@PRD.md @docs/architecture.md
å®ç°ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼š
1. åˆ›å»º Prisma æ•°æ®æ¨¡å‹
2. å®ç° AuthServiceï¼ˆæ³¨å†Œã€ç™»å½•ã€å¯†ç æ‰¾å›ï¼‰
3. å®ç° AuthControllerï¼ˆREST APIï¼‰
4. åˆ›å»º React ç»„ä»¶ï¼ˆLoginForm, RegisterFormï¼‰
5. å®ç° Redux çŠ¶æ€ç®¡ç†
6. ç¼–å†™å®Œæ•´æµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 85%ï¼‰

å®‰å…¨è¦æ±‚ï¼š
- å¯†ç  bcrypt åŠ å¯†
- JWT token è®¤è¯
- é˜²æ­¢æš´åŠ›ç ´è§£
- é‚®ç®±éªŒè¯
```

## 8. éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ç”¨æˆ·å¯ä»¥æ³¨å†Œ
- [ ] é‚®ç®±éªŒè¯æµç¨‹æ­£å¸¸
- [ ] ç”¨æˆ·å¯ä»¥ç™»å½•
- [ ] Token åˆ·æ–°æ­£å¸¸
- [ ] å¯†ç æ‰¾å›æµç¨‹æ­£å¸¸
- [ ] ç”¨æˆ·å¯ä»¥ç™»å‡º

### å®‰å…¨éªŒæ”¶
- [ ] å¯†ç åŠ å¯†å­˜å‚¨
- [ ] Token è¿‡æœŸæœºåˆ¶
- [ ] é˜²æ­¢æš´åŠ›ç ´è§£
- [ ] HTTPS ä¼ è¾“
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] XSS é˜²æŠ¤

### æ€§èƒ½éªŒæ”¶
- [ ] ç™»å½•å“åº”æ—¶é—´ < 500ms (P95)
- [ ] æ³¨å†Œå“åº”æ—¶é—´ < 1s (P95)
- [ ] æ”¯æŒå¹¶å‘ 100 æ³¨å†Œ/ç§’

### æ–‡æ¡£éªŒæ”¶
- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] å®‰å…¨æ–‡æ¡£
- [ ] éƒ¨ç½²æ–‡æ¡£
```

---

## ğŸ“Š çŸ¥è¯†æ£€æŸ¥

### è‡ªæˆ‘è¯„ä¼°

1. **ä¼ ç»Ÿ PRD å’Œ AI åŸç”Ÿ PRD çš„æ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

2. **AI åŸç”Ÿ PRD çš„å…«å¤§è¦ç´ åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ¯ä¸ªéƒ½å¾ˆé‡è¦ï¼Ÿ**

3. **å¦‚ä½•å°†æ¨¡ç³Šçš„éœ€æ±‚è½¬åŒ–ä¸º AI å¯ç†è§£çš„è¯¦ç»†éœ€æ±‚ï¼Ÿ**

4. **åœ¨æ’°å†™åŠŸèƒ½éœ€æ±‚æ—¶ï¼Œå¦‚ä½•ç¡®ä¿å®Œæ•´æ€§ï¼Ÿ**

5. **å¦‚ä½•åˆ©ç”¨ AI åŸç”Ÿ PRD é©±åŠ¨å¼€å‘æµç¨‹ï¼Ÿ**

---

## ğŸ¯ å®è·µå»ºè®®

### PRD æ’°å†™æµç¨‹

```
Step 1: éœ€æ±‚æ”¶é›†
- ä¸äº§å“ç»ç†è®¨è®º
- æ”¶é›†ç”¨æˆ·åé¦ˆ
- åˆ†æç«å“

Step 2: æ’°å†™ PRD
- å¡«å†™å…«å¤§è¦ç´ 
- è¯¦ç»†æè¿°åŠŸèƒ½
- è¡¥å……è¾¹ç•Œæƒ…å†µ

Step 3: PRD è¯„å®¡
- å›¢é˜Ÿè¯„å®¡
- è¯†åˆ«é—æ¼
- å®Œå–„ç»†èŠ‚

Step 4: AI å®ç°
- æä¾›ç»™ AI Agent
- ç›‘æ§å¼€å‘è¿‡ç¨‹
- éªŒè¯å®ç°è´¨é‡

Step 5: æµ‹è¯•éªŒæ”¶
- åŠŸèƒ½æµ‹è¯•
- å®‰å…¨æµ‹è¯•
- æ€§èƒ½æµ‹è¯•

Step 6: æ–‡æ¡£æ›´æ–°
- æ›´æ–° API æ–‡æ¡£
- æ›´æ–°ç”¨æˆ·æ‰‹å†Œ
- æ›´æ–° CHANGELOG
```

### å¸¸è§é™·é˜±

```markdown
# âŒ é¿å…è¿™äº›é”™è¯¯

1. éœ€æ±‚è¿‡äºæ¨¡ç³Š
   "ä¼˜åŒ–æ€§èƒ½" â†’ "åŠ è½½æ—¶é—´ä» 2s ä¼˜åŒ–åˆ° < 500ms"

2. ç¼ºå°‘è¾¹ç•Œæƒ…å†µ
   åªè€ƒè™‘æ­£å¸¸æµç¨‹ï¼Œä¸è€ƒè™‘å¼‚å¸¸

3. æŠ€æœ¯å®ç°ä¸å…·ä½“
   "ä½¿ç”¨åŠ å¯†" â†’ "ä½¿ç”¨ bcryptï¼Œsalt rounds: 10"

4. ç¼ºå°‘éªŒæ”¶æ ‡å‡†
   æ— æ³•åˆ¤æ–­æ˜¯å¦å®Œæˆ

5. å¿½è§†å®‰å…¨
   æ²¡æœ‰è€ƒè™‘è®¤è¯ã€æˆæƒã€æ•°æ®ä¿æŠ¤

# âœ… éµå¾ªè¿™äº›åŸåˆ™

1. SMART ç›®æ ‡
2. å®Œæ•´çš„ç”¨æˆ·æ•…äº‹
3. è¯¦ç»†çš„è¾¹ç•Œæƒ…å†µ
4. å…·ä½“çš„æŠ€æœ¯æ–¹æ¡ˆ
5. æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†
6. å®‰å…¨æ€§ä¼˜å…ˆ
7. å¯æµ‹è¯•æ€§
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

### æœ€ä½³å®è·µ

1. [Writing Great PRDs](https://www.productplan.com/learn/how-to-write-a-prd/)
2. [AI-First Development](https://www.anthropic.com/index/claude-code)
3. [User Story Mapping](https://www.atlassian.com/agile/project-management/user-stories)

### æ¨¡æ¿èµ„æº

1. [PRD Template](https://docs.google.com/document/d/1R5WI2V4n6r3c2dX8kK0M/edit)
2. [API Specification](https://swagger.io/specification/)
3. [User Story Template](https://www.atlassian.com/software/confluence/templates/user-story)

---

**è¯¾ç¨‹æ€»ç»“**: ç°åœ¨ä½ å·²ç»æŒæ¡äº† AI IDE çš„æ ¸å¿ƒæŠ€èƒ½ï¼ä¸‹å‘¨æˆ‘ä»¬å°†è¿›å…¥å®æˆ˜é˜¶æ®µï¼Œä½¿ç”¨è¿™äº›æŠ€èƒ½å®Œæˆä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½å¼€å‘ã€‚
