# 第九章 上下文工程

## 章节概述

上下文是智能体"持续理解"的关键。本章将介绍如何有效管理和优化上下文，让智能体在长对话中保持连贯性。

## 学习目标

- 理解上下文在智能体中的重要性
- 掌握上下文管理的核心技巧
- 学会优化上下文窗口使用
- 能够实现高效的上下文管理系统

---

## 为什么需要上下文工程？

### 上下文的作用

```
┌─────────────────────────────────────────────────────────────┐
│                  上下文的作用                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  无上下文:                                                  │
│  用户: "它多少钱？"                                         │
│  Agent: "抱歉，我不理解你在说什么..."                        │
│                                                             │
│  有上下文:                                                  │
│  上下文: 用户正在询问 iPhone 15 的价格                        │
│  用户: "它多少钱？"                                         │
│  Agent: "iPhone 15 起售价为 $799..."                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 上下文的组成

```
┌─────────────────────────────────────────────────────────────┐
│                    上下文组成                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 对话历史     │  │ 任务上下文   │  │ 背景知识     │         │
│  │             │  │             │  │             │         │
│  │ · 用户输入  │  │ · 当前目标  │  │ · 世界设定  │         │
│  │ · Agent回复 │  │ · 任务状态  │  │ · 角色信息  │         │
│  │ · 时间顺序  │  │ · 中间结果  │  │ · 领域知识  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                         │
│  │ 工具上下文   │  │ 元数据       │                         │
│  │             │  │             │                         │
│  │ · 工具调用  │  │ · 时间戳    │                         │
│  │ · 执行结果  │  │ · 消息ID    │                         │
│  │             │  │ · 状态标记  │                         │
│  └─────────────┘  └─────────────┘                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 上下文管理策略

### 滑动窗口策略

```
滑动窗口法:

┌─────────────────────────────────────────────────────────────┐
│                    滑动窗口示意                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  对话历史: [msg1, msg2, msg3, msg4, msg5, msg6, msg7, ...] │
│                                                             │
│  窗口大小: 4                                                │
│                                                             │
│  时刻1: [msg1, msg2, msg3, msg4]                            │
│           移动 →                                             │
│  时刻2: [msg2, msg3, msg4, msg5]                            │
│           移动 →                                             │
│  时刻3: [msg3, msg4, msg5, msg6]                            │
│                                                             │
│  优点: 简单、可控                                            │
│  缺点: 可能丢失重要信息                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 总结压缩策略

```
总结压缩法:

原始对话 (1000 tokens):
User: 帮我查一下天气
Agent: 好的，请告诉我你的位置
User: 我在北京
Agent: 北京今天晴，温度20-28度
User: 明天呢？
Agent: 北京明天多云，温度18-25度
User: 后天呢？
Agent: 北京后天小雨，温度15-22度
...
         │
         ▼ 总结
压缩后 (200 tokens):
用户询问了北京未来几天的天气，已提供3-7天的预报信息。

优点: 大幅减少token
缺点: 可能丢失细节
```

### 智能筛选策略

```
智能筛选法:

┌─────────────────────────────────────────────────────────────┐
│                  重要性评分机制                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  评分因素:                                                  │
│  · 时间新近度      越新越重要                               │
│  · 关键词匹配      包含关键信息                             │
│  · 用户明确标记  用户标记为重要                             │
│  · 引用频率        被后续消息引用                            │
│                                                             │
│  示例:                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  消息1: "你好"              │ 评分: 1 (低)            │   │
│  │  消息2: "帮我写个排序算法"   │ 评分: 5 (高)            │   │
│  │  消息3: "好的"              │ 评分: 1 (低)            │   │
│  │  消息4: "用快速排序"        │ 评分: 4 (高)            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  筛选结果: 保留消息2和消息4                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 上下文优化技术

### 1. 层级上下文

```
层级上下文结构:

┌─────────────────────────────────────────────────────────────┐
│                     长期记忆层                               │
│  · 用户偏好                                                │
│  · 历史任务                                                │
│  · 重要事件                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 提取相关
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     中期上下文层                              │
│  · 当前会话摘要                                            │
│  · 近期对话                                                │
│  · 任务状态                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 直接使用
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     短期对话层                               │
│  · 最近几轮对话                                            │
│  · 当前问题                                                │
│  · 即时上下文                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. 动态上下文更新

```
动态更新机制:

┌─────────────────────────────────────────────────────────────┐
│                  触发更新条件                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 轮次触发                                                 │
│     ┌────────┐  ┌────────┐  ┌────────┐                     │
│     │ 轮次1  │→│ 轮次5  │→│ 轮次10 │                      │
│     └────────┘  └────────┘  └────────┘                     │
│       每5轮触发一次上下文压缩                                 │
│                                                             │
│  2. Token 触发                                               │
│     累计 token > 阈值 (如 4000) → 触发压缩                    │
│                                                             │
│  3. 话题变化                                                 │
│     检测到话题切换 → 重置上下文                                │
│                                                             │
│  4. 手动触发                                                 │
│     用户或系统指令触发                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. 上下文窗口优化

```
窗口优化策略:

┌─────────────────────────────────────────────────────────────┐
│                  窗口分配                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  总窗口: 4000 tokens                                         │
│                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 系统提示  │ │ 对话历史  │ │ 工具结果  │ │ 用户输入  │       │
│  │  500     │ │  2000    │ │  1000    │ │   500    │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│      12%          50%           25%          12%             │
│                                                             │
│  动态调整:                                                  │
│  · 对话复杂时增加历史空间                                   │
│  · 工具调用多时增加结果空间                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 实践技巧

### 1. 上下文模板设计

```
上下文模板结构:

系统提示 (固定)
    │
    ├── 角色定义
    ├── 能力说明
    └── 约束条件
    │
    ▼
对话历史 (动态)
    │
    ├── 最近N轮对话
    ├── 重要历史摘要
    └── 任务上下文
    │
    ▼
当前输入
    │
    └── 用户最新消息
```

### 2. 摘要生成策略

```
摘要生成时机:

┌─────────────────────────────────────────────────────────────┐
│  什么时候生成摘要？                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 定期摘要                                                │
│     ┌─────┐     ┌─────┐     ┌─────┐                       │
│     │ 10轮 │  →  │ 10轮 │  →  │ 10轮 │                      │
│     └─────┘     └─────┘     └─────┘                       │
│       │           │           │                            │
│       └───────────┴───────────┘                            │
│                    │                                        │
│                    ▼                                        │
│              生成前30轮摘要                                   │
│                                                             │
│  2. 话题切换摘要                                             │
│     话题A结束 → 生成A的摘要 → 开始话题B                         │
│                                                             │
│  3. 重要事件摘要                                             │
│     检测到关键决策/结果 → 记录到摘要                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. 引用机制

```
消息引用系统:

┌─────────────────────────────────────────────────────────────┐
│                    引用机制                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  消息1: "用户名叫张三"                                      │
│  消息2: "张三的年龄是多少？"                                 │
│         └─→ 引用消息1                                        │
│  消息3: "张三今年25岁"                                      │
│  消息4: "他住在哪里？"                                      │
│         └─→ 引用消息1（"他"指"张三"）                        │
│                                                             │
│  引用关系图:                                                 │
│     消息1 ←──── 消息2                                        │
│       │                      │                               │
│       └───────────────→ 消息4                               │
│                                                             │
│  重要性计算:                                                │
│  · 被引用越多越重要                                         │
│  · 引用链越短越重要                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 高级技术

### 1. 向量化检索

```
向量检索优化上下文:

┌─────────────────────────────────────────────────────────────┐
│                  向量检索流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  历史消息库                                                  │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐           │
│  │ msg1   │  │ msg2   │  │ msg3   │  │ msg4   │           │
│  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘           │
│      │           │           │           │                   │
│      ▼           ▼           ▼           ▼                   │
│   ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐                │
│   │向量1 │    │向量2 │    │向量3 │    │向量4 │                │
│   └─────┘    └─────┘    └─────┘    └─────┘                │
│                                    │                         │
│                              ┌─────▼─────┐                   │
│                              │ 当前查询   │                   │
│                              │ 向量化     │                   │
│                              └─────┬─────┘                   │
│                                    │                         │
│                              ┌─────▼─────┐                   │
│                              │ 相似度计算  │                   │
│                              └─────┬─────┘                   │
│                                    │                         │
│                              ┌─────▼─────┐                   │
│                              │ Top-K检索  │                   │
│                              │ (K=3)     │                   │
│                              └─────┬─────┘                   │
│                                    │                         │
│                              ┌─────▼─────┐                   │
│                              │ 返回最相关  │                   │
│                              │ 的3条消息  │                   │
│                              └───────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. 多轮对话摘要

```
分层摘要结构:

原始对话 (20轮, 3000 tokens)
    │
    ▼ 第一层摘要
会话级摘要 (300 tokens)
"用户询问了X产品功能，比较了Y产品，最终决定购买X"
    │
    ▼ 第二层摘要
主题级摘要 (100 tokens)
"产品咨询与购买决策"
    │
    ▼ 第三层摘要
关键词级 (20 tokens)
"购物、产品对比"

优势:
· 粗粒度到细粒度可调
· 节省大量token
· 保留关键信息
```

---

## 常见问题与解决方案

### 问题1：上下文溢出

```
问题: 对话太长，超出模型限制

解决方案:
1. 滑动窗口: 只保留最近N轮
2. 智能压缩: 总结旧对话
3. 分段处理: 长对话分段处理
4. 模型升级: 使用更长上下文模型
```

### 问题2：信息丢失

```
问题: 压缩导致重要信息丢失

解决方案:
1. 重要性评分: 关键信息标记
2. 多层摘要: 保留不同粒度信息
3. 显式保留: 重要信息单独存储
4. 用户确认: 关键决策用户确认
```

### 问题3：上下文不一致

```
问题: 压缩后上下文矛盾

解决方案:
1. 一致性检查: 检测矛盾信息
2. 时间戳标记: 明确信息时效
3. 版本控制: 保留上下文版本
4. 冲突解决: 新信息覆盖旧信息
```

---

## 练习作业

### 基础练习
1. 实现滑动窗口上下文管理
2. 实现简单的对话摘要
3. 实现重要性评分机制

### 进阶练习
4. 实现向量检索上下文
5. 构建多层上下文系统
6. 实现智能上下文压缩

### 挑战练习
7. 实现自适应窗口管理
8. 构建完整的上下文管理系统
9. 优化长对话性能

## 学习资源

### 相关资料
- Context Management 论文
- LangChain Memory 文档
- 滑动窗口算法

## 下一步

完成本章学习后，进入：
- [第10章：通信协议](../ch10-protocols/) - 学习智能体通信

## 学习检查

- [ ] 理解上下文工程的重要性
- [ ] 掌握主要上下文管理策略
- [ ] 能够实现上下文管理系统
- [ ] 了解上下文优化技巧
- [ ] 完成章节练习题
