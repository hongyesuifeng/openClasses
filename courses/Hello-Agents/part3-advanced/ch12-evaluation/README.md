# 第十二章 智能体性能评估

## 章节概述

如何评估智能体的好坏？本章将介绍核心指标、基准测试方法，以及如何设计评估方案。

## 学习目标

- 理解智能体评估的重要性
- 掌握核心评估指标
- 能够设计和执行评估方案
- 了解主流评估框架

---

## 为什么需要评估？

```
评估的价值:

┌─────────────────────────────────────────────────────────────┐
│  没有评估:                                                   │
│  · 不知道效果好坏                                            │
│  · 无法对比不同方案                                          │
│  · 优化缺乏方向                                              │
│  · 难以发现问题和改进                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  有评估:                                                     │
│  · 量化性能指标                                              │
│  · 对比不同模型/方法                                         │
│  · 指导优化方向                                              │
│  · 持续改进质量                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 评估指标体系

### 分类

```
评估指标分类:

┌─────────────────────────────────────────────────────────────┐
│  任务完成度                                                  │
│  · 成功率                                                    │
│  · 完成时间                                                  │
│  · 步骤数                                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  回答质量                                                    │
│  · 准确性                                                    │
│  · 完整性                                                    │
│  · 相关性                                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  效率指标                                                    │
│  · Token消耗                                                 │
│  · API调用次数                                               │
│  · 响应时间                                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  用户体验                                                    │
│  · 满意度                                                    │
│  · 易用性                                                    │
│  · 交互流畅度                                                │
└─────────────────────────────────────────────────────────────┘
```

### 核心指标详解

#### 1. 成功率

```
成功率计算:

伪代码:
function calculate_success_rate(test_cases):
    success_count = 0
    for case in test_cases:
        result = agent.run(case)
        if result.success:
            success_count += 1

    return success_count / len(test_cases)

考虑因素:
· 任务类型差异
· 难度分级
· 容错机制
```

#### 2. 平均完成步数

```
步数评估:

定义: 完成任务平均需要多少轮对话

示例:
简单任务: 平均2-3轮
中等任务: 平均5-10轮
复杂任务: 平均10+轮

优化方向:
· 提高理解能力 (减少确认)
· 改进规划 (少走弯路)
· 优化工具使用 (批量操作)
```

#### 3. Token效率

```
Token效率指标:

┌──────────────────────────────────────────────────────────┐
│  总Token消耗                                               │
│  = 输入Token + 输出Token                                   │
├──────────────────────────────────────────────────────────┤
│  Token/任务                                               │
│  = 总Token / 完成的任务数                                  │
├──────────────────────────────────────────────────────────┤
│  Token/步骤                                               │
│  = 总Token / 执行步数                                     │
└──────────────────────────────────────────────────────────┘

优化策略:
· 优化Prompt (精简系统提示)
· 压缩上下文 (摘要历史)
· 批量操作 (减少调用)
```

---

## 基准测试方法

### 数据集评估

```
基准测试数据集:

┌──────────────────────────────────────────────────────────┐
│  学术基准                                                  │
│  · MMLU (综合知识)                                        │
│  · GSM8K (数学)                                           │
│  · HumanEval (代码)                                       │
│  · BBH (推理)                                             │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  Agent基准                                                 │
│  · AgentBench (通用Agent)                                 │
│  · ToolBench (工具使用)                                   │
│  · InterCode (交互编程)                                   │
│  · SWE-bench (软件工程)                                    │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  自定义基准                                                 │
│  · 针对特定任务                                           │
│  · 更贴近实际应用                                          │
│  · 可控和可定制                                            │
└──────────────────────────────────────────────────────────┘
```

### 评估流程

```
标准评估流程:

准备测试集
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  运行测试                                              │
│  for each test_case:                                  │
│      result = agent.run(test_case)                    │
│      metrics.update(result)                            │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  计算指标                                              │
│  · 成功率                                               │
│  · 平均耗时                                             │
│  · Token消耗                                           │
│  · 错误分析                                             │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  生成报告                                              │
│  · 汇总统计                                             │
│  · 案例分析                                             │
│  · 对比图表                                             │
└─────────────────────────────────────────────────────┘
```

---

## 评估框架

### LangChain Evaluators

```
LangChain 评估组件:

┌──────────────────────────────────────────────────────────┐
│  String Evaluators                                        │
│  · ExactMatch: 精确匹配                                  │
│  · Similarity: 相似度评分                                 │
│  · Regex: 正则匹配                                       │
│  · Custom: 自定义规则                                    │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  Embedding Evaluators                                     │
│  · Cosine Similarity: 余弦相似度                          │
│  · Euclidean Distance: 欧氏距离                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  LLM-as-Judge                                             │
│  · 用LLM评估输出                                          │
│  · 可评估复杂标准                                          │
│  · 需要设定评分Prompt                                      │
└──────────────────────────────────────────────────────────┘
```

### 自定义评估框架

```
评估框架设计:

┌─────────────────────────────────────────────────────────────┐
│                    评估框架架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐                                           │
│  │  测试用例    │ ───→ 加载测试数据                          │
│  └──────────────┘                                           │
│                                                             │
│  ┌──────────────┐                                           │
│  │  Agent执行   │ ───→ 运行Agent                            │
│  └──────┬───────┘                                           │
│         │                                                    │
│         ▼                                                    │
│  ┌──────────────┐                                           │
│  │  结果收集    │ ───→ 收集执行结果                          │
│  └──────┬───────┘                                           │
│         │                                                    │
│         ▼                                                    │
│  ┌──────────────┐                                           │
│  │  指标计算    │ ───→ 计算各项指标                          │
│  └──────┬───────┘                                           │
│         │                                                    │
│         ▼                                                    │
│  ┌──────────────┐                                           │
│  │  报告生成    │ ───→ 生成评估报告                          │
│  └──────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 实践案例

### 案例：代码Agent评估

```
评估方案:

任务: 完成编程任务

指标定义:
┌──────────────────────────────────────────────────────────┐
│  1. 正确性 (60%)                                          │
│     · 代码能运行通过                                      │
│     · 输出结果正确                                        │
├──────────────────────────────────────────────────────────┤
│  2. 效率 (20%)                                            │
│     · 完成时间                                            │
│     · 代码质量                                            │
├──────────────────────────────────────────────────────────┤
│  3. 鲁棒性 (20%)                                          │
│     · 边界条件处理                                        │
│     · 错误处理                                            │
└──────────────────────────────────────────────────────────┘

测试用例设计:
· 简单算法 (排序、查找)
· 中等任务 (文件处理、数据处理)
· 复杂任务 (API调用、多模块)
```

### 案例：对话Agent评估

```
评估方案:

任务: 用户对话服务

指标:
┌──────────────────────────────────────────────────────────┐
│  1. 任务完成率                                            │
│     用户意图是否达成                                     │
├──────────────────────────────────────────────────────────┤
│  2. 对话轮次                                              │
│     平均需要多少轮                                        │
├──────────────────────────────────────────────────────────┤
│  3. 满意度评分                                             │
│     人工打分 (1-5分)                                      │
├──────────────────────────────────────────────────────────┤
│  4. 转化率                                                 │
│     是否需要转人工                                        │
└──────────────────────────────────────────────────────────┘
```

---

## 评估结果分析

### 错误分析

```
错误分类:

┌──────────────────────────────────────────────────────────┐
│  理解错误                                                  │
│  · 误解用户意图                                           │
│  · 遗漏关键信息                                           │
│  · 上下文理解偏差                                         │
├──────────────────────────────────────────────────────────┤
│  规划错误                                                  │
│  · 步骤顺序错误                                           │
│  · 方案不合理                                             │
│  · 遗漏必要步骤                                           │
├──────────────────────────────────────────────────────────┤
│  执行错误                                                  │
│  · 工具调用失败                                           │
│  · 参数错误                                               │
│  · 异常未处理                                             │
├──────────────────────────────────────────────────────────┤
│  输出错误                                                  │
│  · 格式错误                                               │
│  · 内容不完整                                             │
│  · 表达不清晰                                             │
└──────────────────────────────────────────────────────────┘
```

### 改进建议

```
基于评估的改进:

如果成功率低:
→ 检查Prompt
→ 增加示例
→ 改进工具

如果效率低:
→ 优化上下文
→ 批量操作
→ 改进规划

如果满意度低:
→ 调整风格
→ 增加互动
→ 优化输出
```

---

## 练习作业

### 基础练习
1. 定义评估指标
2. 设计测试用例
3. 实现简单评估脚本

### 进阶练习
4. 构建完整评估框架
5. 进行A/B测试对比
6. 分析失败案例

### 挑战练习
7. 设计领域特定基准
8. 实现自动化评估流程
9. 构建评估仪表盘

## 学习资源

### 相关资料
- AgentBench 论文
- LangChain Evaluation 文档
- 评估指标研究

## 下一步

完成本章学习后，进入：
- [第13章：智能旅行助手](../../part4-cases/ch13-travel-agent/) - 实战项目

## 学习检查

- [ ] 理解评估的重要性
- [ ] 掌握核心评估指标
- [ ] 能够设计评估方案
- [ ] 了解评估框架
- [ ] 完成章节练习题
