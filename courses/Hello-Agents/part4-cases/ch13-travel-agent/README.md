# 第十三章 智能旅行助手

## 章节概述

本章将通过一个完整的智能旅行助手项目，综合运用前面学到的知识，包括 MCP 协议、多智能体协作等。

## 学习目标

- 理解真实世界项目的复杂性
- 掌握多智能体协作的实践方法
- 学会设计系统架构
- 能够独立实现智能体应用

---

## 项目背景

### 需求描述

```
用户需求:

"我想要一个智能旅行助手，能够：

1. 帮我规划旅行路线
2. 查询航班和酒店信息
3. 推荐景点和餐厅
4. 提供实时天气查询
5. 预算管理和建议
6. 行程提醒和注意事项

最重要的是要自然对话，像真人助手一样！"
```

### 核心功能

```
功能模块:

┌──────────────────────────────────────────────────────────┐
│  行程规划                                                  │
│  · 根据时间和偏好生成行程                                  │
│  · 优化路线安排                                           │
│  · 考虑交通和天气                                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  信息查询                                                  │
│  · 航班查询                                               │
│  · 酒店预订                                               │
│  · 景点信息                                               │
│  · 餐厅推荐                                               │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  智能推荐                                                  │
│  · 基于偏好的景点推荐                                      │
│  · 符合预算的酒店选择                                      │
│  · 当地特色餐厅                                           │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  实时服务                                                  │
│  · 天气查询                                               │
│  · 交通状况                                               │
│  · 行程提醒                                               │
└──────────────────────────────────────────────────────────┘
```

---

## 系统架构

### 整体架构

```
系统架构图:

┌─────────────────────────────────────────────────────────────┐
│                       用户界面                               │
│  (聊天界面 / 语音 / 移动App)                                │
└──────────────────────────────────────┬──────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    协调层 (Manager Agent)                       │
│  · 理解用户意图                                               │
│  · 分配子任务                                                 │
│  · 汇总结果                                                   │
└──────┬────────────────────────────────────────┬──────────────┘
       │                                        │
       ├─────────────────┬─────────────┬───────┴───────┐
       │                 │             │               │
       ▼                 ▼             ▼               ▼
┌──────────┐    ┌──────────┐   ┌──────────┐    ┌──────────┐
│ 行程规划   │    │ 信息查询   │   │ 推荐系统   │    │ 实时服务   │
│ Agent    │    │ Agent    │   │ Agent    │    │ Agent    │
└──────────┘    └──────────┘   └──────────┘    └──────────┘
       │                │               │               │
       └────────────────┴───────────────┴───────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       MCP Server层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Flight API   │  │ Hotel API    │  │ Weather API   │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │ Attraction API│ │ Restaurant API│                        │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

```
用户交互流程:

用户: "我想去日本旅行5天，预算1万"
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  Manager Agent                                        │
│  分析:                                             │
│  · 目的地: 日本                                      │
│  · 时长: 5天                                        │
│  · 预算: 10000                                      │
│                                                      │
│  需要调用:                                           │
│  · 行程规划Agent (生成方案)                           │
│  · 信息查询Agent (查询价格)                           │
│  └──────→ 协调执行                                    │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  行程规划Agent                                        │
│  生成: 东京5日行程                                     │
│  · Day1: 抵达，东京市区                                │
│  · Day2: 东京迪士尼                                   │
│  · Day3: 富士山一日游                                 │
│  · Day4: 京都古寺巡礼                                 │
│  · Day5: 购物，返程                                   │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  信息查询Agent                                        │
│  查询:                                              │
│  · 航班价格: ¥3000                                    │
│  · 酒店价格: ¥4000 (5晚)                              │
│  · 餐饮预算: ¥2000                                   │
│  · 景点门票: ¥500                                    │
│                                                      │
│  总计: ¥9500 (< 预算 ✓)                              │
└─────────────────────────────────────────────────────┘
    │
    ▼
返回用户: "根据您的预算，我为您规划了..."
```

---

## Agent 设计

### Manager Agent

```
角色: 协调者

职责:
┌──────────────────────────────────────────────────────────┐
│  1. 意图识别                                              │
│     识别用户想要做什么                                     │
├──────────────────────────────────────────────────────────┤
│  2. 任务分解                                              │
│     将复杂任务分解为子任务                                 │
├──────────────────────────────────────────────────────────┤
│  3. Agent调度                                             │
│     分配任务给专门的Agent                                  │
├──────────────────────────────────────────────────────────┤
│  4. 结果整合                                              │
│     汇总所有Agent的结果                                    │
├──────────────────────────────────────────────────────────┤
│  5. 质量控制                                              │
│     检查结果合理性                                         │
└──────────────────────────────────────────────────────────┘
```

### 规划Agent

```
角色: 行程规划师

工作流程:
用户需求
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  收集偏好                                             │
│  · 出发时间                                           │
│  · 旅行类型 (休闲/冒险/文化)                          │
│  · 特殊需求                                           │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  生成行程草案                                         │
│  ┌─────────────────────────────────────────────────┐ │
│  │ Day 1: ...                                       │ │
│  │ Day 2: ...                                       │ │
│  │ Day 3: ...                                       │ │
│  │ ...                                              │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  优化行程                                             │
│  · 地理位置优化                                         │
│  · 时间安排优化                                         │
│  · 考虑天气因素                                         │
└─────────────────────────────────────────────────────┘
```

### 信息查询Agent

```
角色: 信息查询员

工具:
┌──────────────────────────────────────────────────────────┐
│  search_flights()                                        │
│  输入: 出发地, 目的地, 日期                                │
│  输出: 航班列表 (价格, 时间, 航空公司)                      │
├──────────────────────────────────────────────────────────┤
│  search_hotels()                                         │
│  输入: 城市, 日期, 入住天数                                │
│  输出: 酒店列表 (价格, 评分, 位置)                          │
├──────────────────────────────────────────────────────────┤
│  get_weather()                                           │
│  输入: 城市, 日期                                         │
│  输出: 天气预报                                           │
└──────────────────────────────────────────────────────────┘
```

---

## MCP 实现

### Server 配置

```
MCP Server 设计:

resources:
  /flights/{origin}/{dest}/{date}
    → 航班信息

  /hotels/{city}/{date}
    → 酒店信息

  /attractions/{city}
    → 景点列表

tools:
  book_flight()
    → 预订航班

  book_hotel()
    → 预订酒店

  get_weather_forecast()
    → 获取天气预报
```

### Client 调用

```
调用流程:

Agent 决策: 需要查询航班
    │
    ▼
MCP Client:
  call_tool("search_flights", {
    "origin": "北京",
    "destination": "东京",
    "date": "2024-03-01"
  })
    │
    ▼
MCP Server:
  调用Flight API
    │
    ▼
返回结果:
  [
    {
      "airline": "全日空",
      "price": 3500,
      "duration": "3小时"
    },
    ...
  ]
```

---

## 多Agent协作

### 协作场景

```
场景: 用户修改行程

用户: "第二天不想去迪士尼了，想改去浅草寺"

协作流程:
┌─────────────────────────────────────────────────────┐
│  Manager: 收到修改请求                               │
└──────────────┬──────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────┐
│  规划Agent: 调整第二天行程                           │
│  · 移除: 东京迪士尼                                 │
│  · 添加: 浅草寺                                     │
│  · 调整: 时间安排                                   │
└──────────────┬──────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────┐
│  推荐Agent: 提供浅草寺相关信息                       │
│  · 开放时间                                         │
│  · 门票价格                                         │
│  · 交通方式                                         │
│  · 周边推荐                                         │
└──────────────┬──────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────┐
│  Manager: 整合结果，回复用户                         │
└─────────────────────────────────────────────────────┘
```

### 状态管理

```
会话状态管理:

状态结构:
{
  "user_profile": {
    "preferences": [],
    "budget": 10000,
    "constraints": []
  },
  "current_plan": {
    "destination": "日本",
    "duration": 5,
    "days": [...]
  },
  "conversation_history": [...],
  "pending_tasks": [...]
}
```

---

## 实现要点

### 1. Prompt设计

```
系统Prompt模板:

你是一个专业的旅行助手助手，名字叫"小游"。

核心能力:
1. 行程规划 - 根据用户需求制定详细行程
2. 信息查询 - 查询航班、酒店、景点等信息
3. 智能推荐 - 基于用户偏好提供个性化建议
4. 实时服务 - 提供天气、交通等实时信息

工作原则:
- 始终以用户需求为中心
- 考虑预算和时间限制
- 提供多个选项供选择
- 主动提醒注意事项
- 保持友好和专业的语气

当前会话状态: {context}
```

### 2. 错误处理

```
错误处理策略:

API调用失败 → 提供替代方案
    │
    ├─→ 航班查询失败
    │     → "航班信息暂时无法获取，建议您直接查看航空公司官网"
    │
    └─→ 酒店查询失败
          → "暂时无法查询酒店，以下是一些推荐区域..."

用户意图不清 → 主动询问
    │
    └─→ "您提到想去日本，能告诉我更具体的计划吗？比如出行时间、预算等"
```

---

## 项目总结

### 关键收获

```
实践要点:

1. 架构设计
   · 分层设计 (协调层 + 执行层)
   · 职责分离 (专门Agent做专门事)
   · 灵活扩展 (易于添加新功能)

2. MCP应用
   · 统一数据访问
   · 解耦Agent和API
   · 简化工具调用

3. 多Agent协作
   · 明确角色定位
   · 设计通信协议
   · 处理冲突和依赖

4. 用户体验
   · 自然对话
   · 主动提醒
   · 个性化建议
```

---

## 扩展方向

```
可扩展功能:

┌────────────────────────────────────┐
│  语音交互                           │
│  · 语音输入                         │
│  · 语音输出                         │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│  预订功能                           │
│  · 在线预订                         │
│  · 订单管理                         │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│  社交功能                           │
│  · 行程分享                         │
│  · 结伴旅行                         │
└────────────────────────────────────┘
```

---

## 练习作业

### 基础练习
1. 设计系统架构图
2. 定义Agent角色和职责
3. 实现简单的对话流程

### 进阶练习
4. 实现行程规划Agent
5. 集成MCP Server
6. 实现多Agent协作

### 挑战练习
7. 完整实现旅行助手
8. 添加语音交互
9. 部署为Web应用

## 学习资源

### 相关资料
- MCP 协议文档
- 多Agent系统设计

## 下一步

完成本章学习后，进入：
- [第14章：深度研究智能体](../ch14-research-agent/) - 复现DeepResearch

## 学习检查

- [ ] 理解完整项目的架构设计
- [ ] 掌握多Agent协作实现
- [ ] 了解MCP的实际应用
- [ ] 能够设计类似系统
- [ ] 完成章节练习题
